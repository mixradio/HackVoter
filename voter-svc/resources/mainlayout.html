<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hack Voter</title>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/assets/css/reset.css">
  <link rel="stylesheet" href="/assets/css/styles.css">
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery-color/2.1.2/jquery.color.js"></script>
</head>
<body>
  <div class="container-outer">
    <div class="container-inner">
      <div class="container-logo">
        <a href="/"><img class="logo" src="/assets/img/logo.svg" alt="Hack Voter"/></a>
      </div>
      <div class="blurb">{TITLE}</div>
      <div class="blurb">
{CONTENT}
      </div>
    </div>
  </div>
  <script type="text/javascript">
    if((typeof(allowvoting) !== 'undefined') && allowvoting) {
      var votes = null;
      var votesused = 0;
      var flashing = false;
      var floaterorigcolour = $.Color($('#uservotefloater'),'background-color');

      $.get("/votes").done(function(data) {
        votes = data;
        updatevotes();
      });

      function updatevotes() {
        votesused = 0;
        // sum up votes used...
        for(var i=0;i<votes.length;i++) {
          var id = votes[i].id;
          var votecount = votes[i].uservotes;
          votesused += votecount;
          $('#' + id).find(".uservote").html(votecount);
          var votedown = $('#' + id).find(".votebtndown");
          if(votecount == 0)
            votedown.prop('disabled', true);
          else
            votedown.prop('disabled', false);
        }

        // update votes used...
        updatevotefloater(votesused);

        // now enable / disable vote up buttons based on votes left:
        for(var i=0;i<votes.length;i++) {
          var id = votes[i].id;
          var voteup = $('#' + id).find(".votebtnup");
          if(votesused == allocation)
            voteup.prop('disabled', true);
          else
            voteup.prop('disabled', false);
        }
      }

      function vote(id, vote) {
        var newtotalvotes = votesused + vote;
        if(newtotalvotes > allocation) {
          flashvotefloater();
          return;
        }
        for (var i=0;i<votes.length;i++) {
          var voteitem = votes[i];
          if(id == voteitem.id) {
            var newvote = voteitem.uservotes + vote;
            if(newvote < 0) {
              newvote = 0;
            }
            else if(newvote > maxspend) {
              newvote = maxspend;
              flashvotefloater();
            }

            if(voteitem.uservotes != newvote) {
              voteitem.uservotes = newvote;
              $.post('/hacks/' + id + '/votes', {"votes": newvote},function(data) {
                votes = data;
                updatevotes();
              });
            }
            break;
          }
        }
        updatevotes();
      }

      function flashvotefloater() {
        if(flashing)
          return;
        flashing = true;
        var floater = $('#uservotefloater');
        floater.animate({backgroundColor: '#ff2e80'}, 100).animate({backgroundColor: floaterorigcolour}, 200);
        flashing = false;
      }

      function updatevotefloater(votesused) {
        if(allowvoting) {
          var summary = (votesused == allocation ? "all" : votesused) + " of your " + allocation + " " + currency;
          $('#uservotefloater').html("You have spent " + summary + "<br/>You can use up to " + maxspend + " " + currency + " per hack");
          $('#uservotefloater').show();
        }
      }
    }

    function confirmdelete(title, deleteuri) {
      if(confirm('Are you sure you want to delete "' + title + '"?')) {
        window.location=deleteuri;
      }
    }

    function newimageuploaded(url) {
      $('#imgurl').val(url);
      $('#editpreview').attr("src",url);
      var msg = $('#noimg');
      if(msg) msg.hide();
      $('.message').html('Don\'t forget to save your changes');
    }
  </script>
</body>
</html>
